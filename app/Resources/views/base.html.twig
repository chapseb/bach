{% extends ['::' ~ client_code ~ '_layout.html.twig', '::layout.html.twig'] %}

{% block html_headers %}
    <meta charset="utf-8">
    <title>Bach{% block title_extend %}{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="{% trans %}Bach archival search tool{% endtrans %}">
    {% block page_metadata %}
    <meta name="description" content="{% trans %}Bach archival search tool{% endtrans %}">
    <meta name="author" content="Anaphore">
    {% endblock %}
    {# Scripts should be at the bottom of the page... But SonataAdmin is *not* happy with that -_- #}
    <script src="{{ asset('js/jquery-1.10.2.min.js') }}" type="text/javascript"></script>
    <link href="{{ asset('css/reset.css') }}" type="text/css" rel="stylesheet" media="screen" />
    <link href="{{ asset('css/bach.css') }}" type="text/css" rel="stylesheet" media="screen" />
    <link href="{{ asset('css/bach_print.css') }}" type="text/css" rel="stylesheet" media="print"/>
    {% if client_code != '' %}
        {% if asset_exists('/css/' ~ client_code ~ '.css') %}
        <link href="{{ asset('/css/' ~ client_code ~ '.css') }}" type="text/css" rel="stylesheet" media="screen" />
        {% endif %}
        {% if asset_exists('/css/' ~ client_code ~ '_print.css') %}
        <link href="{{ asset('css/' ~ client_code ~ '_print.css') }}" type="text/css" rel="stylesheet" media="screen" />
        {% endif %}
    {% endif %}
    <link href="{{ asset('css/jquery-ui/jquery-ui-1.10.3.custom.min.css') }}" type="text/css" rel="stylesheet" media="screen" />
    <!--[if lt IE 9]>
        <script src="{{ asset('js/html5-ie.js') }}"></script>
        <link href="{{ asset('css/bach-ie.css') }}" type="text/css" rel="stylesheet" media="screen" />
        {% if client_code != '' and asset_exists('/css/' ~ client_code ~ '-ie.css') %}
        <link href="{{ asset('css/' ~ client_code ~ '-ie.css') }}" type="text/css" rel="stylesheet" media="screen" />
        {% endif %}
    <![endif]-->
    <!--[if lte IE 7]>
        <link href="{{ asset('css/bach-ie7.css') }}" type="text/css" rel="stylesheet" media="screen" />
        {% if client_code != '' and asset_exists('/css/' ~ client_code ~ '-ie7.css') %}
        <link href="{{ asset('css/' ~ client_code ~ '-ie7.css') }}" type="text/css" rel="stylesheet" media="screen" />
        {% endif %}
    <![endif]-->
    <link rel="shortcut icon" href="{{ asset('img/favicon.png') }}" />
{% endblock %}

{% block header %}
    <aside id="menu" role="search">
        <header class="header">
            <h1><a href="{{ path('bach_homepage') }}"><img src="{{ asset('img/logo.png') }}" alt="Bach"/></a></h1>
        </header>
        {{ block('menu') }}
    </aside>
{% endblock %}

{% block navigation %}
            <nav role="navigation" id="navigation" class="nav-opened">
            {% spaceless %}
                <ul>
                    <li{% if app.request.attributes.get('_route') == 'bach_homepage' or app.request.attributes.get('_route') == 'bach_search' %} class="active"{% endif %}>
                        <a href="{{ path('bach_search') }}">{% trans %}Search{% endtrans %}</a>
                    </li>
                    {% if matricules %}
                    <li{% if app.request.attributes.get('_route') == 'bach_matricules' %} class="active"{% endif %}>
                        <a href="{{ path('bach_matricules') }}">{% trans %}Matricules{% endtrans %}</a>
                    </li>
                    {% endif %}
                    {% if cdc %}
                     <li{% if app.request.attributes.get('_route') == 'bach_classification' %} class="active"{% endif %}>
                        <a href="{{ path('bach_classification') }}">{% trans %}Classification scheme{% endtrans %}</a>
                    </li>
                    {% endif %}
                    <li{% if app.request.attributes.get('_route') == 'bach_browse' %} class="active"{% endif %}>
                        <a href="{{ path('bach_browse') }}">{% trans %}Browse{% endtrans %}</a>
                    </li>
                    {% if expos %}
                    <li{% if app.request.attributes.get('_route') == 'expos_homepage' %} class="active"{% endif %}>
                        <a href="{{ path('expos_homepage') }}">{% trans %}Virtual expositions{% endtrans %}</a>
                    </li>
                    {% endif %}
                    {% if app.user and is_granted("IS_AUTHENTICATED_REMEMBERED") %}
                        {% if is_granted('ROLE_ARCHIVIST') %}
                    <li{% if app.request.attributes.get('_route')|slice(0, 15) == 'bach_indexation' %} class="active"{% endif %}>
                        <a href="{{ path('bach_indexation_homepage') }}">{% trans %}Publish{% endtrans %}</a>
                    </li>
                        {% endif %}
                        {% if is_granted('ROLE_ADMIN') or is_granted('ROLE_CONTENT_ADMIN') %}
                    <li{% if app.request.attributes.get('_route') == 'sonata_admin_dashboard' %} class="active"{% endif %}>
                        <a href="{{ url('sonata_admin_dashboard') }}">{% trans %}Manage{% endtrans %}</a>
                    </li>
                        {% endif %}
                        {% if is_granted('ROLE_SUPER_ADMIN') %}
                    <li{% if app.request.attributes.get('_route') == 'administration_dashboard' %} class="active"{% endif %}>
                        <a href="{{ url('administration_dashboard') }}">{% trans %}Manage Solr{% endtrans %}</a>
                    </li>
                        {% endif %}
                    {% endif %}
                </ul>
            {% endspaceless %}
            </nav>
{% endblock %}

{% block login %}
            <div id="user_login">
            {% if app.user and is_granted("IS_AUTHENTICATED_REMEMBERED") %}
                {{ 'layout.logged_in_as'|trans({'%username%': app.user.username}, 'FOSUserBundle') }} <a href="{{ path('sonata_user_profile_show') }}">{% trans %}My profile{% endtrans %}</a>
                <a class="logout" href="{% if is_granted('ROLE_PREVIOUS_ADMIN') %}?_switch_user=_exit{% else %}{{ path('fos_user_security_logout') }}{% endif %}">
                    {{ 'layout.logout'|trans({}, 'FOSUserBundle') }}
                </a>
            {% else %}
                <a class="login" href="{{ path('fos_user_security_login') }}">{{ 'layout.login'|trans({}, 'FOSUserBundle') }}</a>
                {% if openid %}
                <a class="openid" href="{{ path('fp_openid_security_login') }}" title="{% trans %}Login with OpenID{% endtrans %}"><img src="{{ asset('img/openid-16x16.gif') }}" alt="OpenID"/></a>
                {% endif %}
            {% endif %}
            </div>

{% endblock %}

{% block flash_messages %}
            {# Globally display errors #}
            {% if app.session.flashbag.has('errors') %}
            <div id="flash-errors" class="noscript">
                <h3>{% trans %}Error{% endtrans %}</h3>
                {% for flashMessage in app.session.flashbag.get('errors') %}
                <div class="flash-message">
                    {{ flashMessage | raw }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {# Globally display warnings #}
            {% if app.session.flashbag.has('warnings') %}
            <div id="flash-warnings" class="noscript">
                <h3>{% trans %}Warning{% endtrans %}</h3>
                {% for flashMessage in app.session.flashbag.get('warnings') %}
                <div class="flash-message">
                    {{ flashMessage | raw }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {# Globally display success #}
            {% if app.session.flashbag.has('success') %}
            <div id="flash-success" class="noscript">
                <h3>{% trans %}Done{% endtrans %}</h3>
                {% for flashMessage in app.session.flashbag.get('success') %}
                <div class="flash-message">
                    {{ flashMessage | raw }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
{% endblock %}

{% block content %}
    {{ block('navigation') }}
    {{ block('login') }}
    {{ block('flash_messages') }}
    {{ block('container') }}
{% endblock %}

{% block main_js %}
    {# Javascript that are required everywhere #}
    <script src="{{ asset('js/jquery-ui/jquery.ui.core.min.js')  }}" type="text/javascript"></script>
    <script src="{{ asset('js/jquery-ui/jquery.ui.widget.min.js')  }}" type="text/javascript"></script>
    <script src="{{ asset('js/jquery-ui/jquery.ui.mouse.min.js')  }}" type="text/javascript"></script>
    <script src="{{ asset('js/jquery-ui/jquery.ui.position.min.js')  }}" type="text/javascript"></script>
    <script src="{{ asset('js/jquery-ui/jquery.ui.button.min.js')  }}" type="text/javascript"></script>
    <script src="{{ asset('js/jquery-ui/jquery.ui.dialog.min.js')  }}" type="text/javascript"></script>
    <script src="{{ asset('js/jquery-ui/jquery.ui.tooltip.min.js')  }}" type="text/javascript"></script>
    {# Additionnal page javascripts #}
    {{ block('js_calls') }}
    <script type="text/javascript">
        {% block javascripts %}{% endblock %}

        _mobile = function(){
            if ( window.innerWidth < 768 ) {
                //hide per default on mobile
                $('#navigation > ul').toggleClass('hidden')
                $('#navigation').on('click', function(){
                    $(this).find('ul').toggleClass('hidden');
                });
                {{ block ('mobile_js_on') }}
            } else {
                //unbind elements and remove class when resizing
                $('#navigation > ul').removeClass('hidden');
                $('#navigation').unbind('click');
                {{ block ('mobile_js_off') }}
            }
        };
        _mobile();

        $(document).ready(function () {

            $(window).resize(function() {
                _mobile();
            });

            $('.jbtn').button();

            //TODO: remove or set in admin
            $('#coreTitleDialog').bind('show');
            $('#renamdialog').bind('show');

            //tooltip on each a
            $('a').tooltip();

            //global help display window
            var _help = $('#help_window');

            if ( _help.length == 0 ) {
                var _help = $('<div id="help_window"><h3>{% trans %}Help not available{% endtrans %}</h3>{% trans %}No help is available for this section.{% endtrans %}</div>');
                _help.appendTo('body');
            }

            _help.dialog({
                autoOpen: false,
                title: _help.children('h3:first-child').text(),
                create: function() {
                    _help.children('h3:first-child').remove();
                }
            });

            $('#show_help').click(function(){
                _help.dialog('open');
                return false;
            });

        });
    </script>
{% endblock %}
