{% extends '::base.html.twig' %}

{% block css %}
    <link href="{{ asset('css/jquery-ui/jquery.ui.tabs.min.css') }}" type="text/css" rel="stylesheet" media="screen" />
{% endblock %}

{% block container %}
<div id="tabs">
    <ul>
        <li{% if part == 'cSubject' %} class="active"{% endif %}><a href="{% if part == 'cSubject' %}#cSubject{% else %}{{ path('bach_browse', {part: 'cSubject', show_all: show_all}) }}{% endif %}">{% trans %}Subjects{% endtrans %}</a></li>
        <li{% if part == 'cPersname' %} class="active"{% endif %}><a href="{% if part == 'cPersname' %}#cPersname{% else %}{{ path('bach_browse', {part: 'cPersname', show_all: show_all}) }}{% endif %}">{% trans %}Persons{% endtrans %}</a></li>
        <li{% if part == 'cGeogname' %} class="active"{% endif %}><a href="{% if part == 'cGeogname' %}#cGeogname{% else %}{{ path('bach_browse', {part: 'cGeogname', show_all: show_all}) }}{% endif %}">{% trans %}Places{% endtrans %}</a></li>
    </ul>
    {% include 'BachHomeBundle:Default:browse_tab_contents.html.twig' with {'part': part, 'lists': lists, 'show_all': show_all} %}
</div>
{% endblock %}

{% block js_calls %}
    {{ parent() }}
    <script src="{{ asset('js/jquery-ui/jquery.ui.tabs.min.js') }}" type="text/javascript"></script>
{% endblock %}

{% block javascripts %}
        var _show_all = function(part){
            $('#' + part + ' h4 .show_all').click(function(){
                var _da_url = '{{ path('bach_browse', {part: 'PARTNAME', show_all: 'show_all', ajax: 'ajax'}) }}';
                _da_url = _da_url.replace('PARTNAME', part),
                $.ajax({
                    url: _da_url,
                    type: 'POST',
                    beforeSend: function() {
                        var _img = $('<figure id="loading"><p><img src="{{ asset('img/loading.png') }}" alt="{% trans %}Loading...{% endtrans %}"/><br/>{% trans %}Currently loading...{% endtrans %}</p></figure>');
                        $('body').append(_img);
                    },
                    complete: function() {
                        $('#loading').remove();
                    },
                    success: function(data) {
                        var _elt = $('#' + part);
                        var _dest;
                        if ( _elt.hasClass('ui-tabs-panel') ) {
                            _elt.empty();
                            _dest = _elt;
                        } else {
                            _dest = _elt.parent('.ui-tabs-panel');
                            _elt.remove();
                        }
                        _dest.append(data);
                    },
                    error: function(){
                        alert('{% trans %}An error occured loading terms :("{% endtrans %}');
                    }
                });

                return false;
            });
        }

        $(function() {
            $('#tabs > ul a').each(function(){
                var _this = $(this);
                var _href = _this.attr('href') + '/ajax';
                if ( !_href.match(/^#.*/) ) {
                    $(this).attr('href', _href);
                }
            });

            $('#tabs').tabs({
                active: $('#tabs li.active').index(),
                beforeLoad: function( event, ui ) {
                    if ( ui.tab.data( "loaded" ) ) {
                        event.preventDefault();
                        return;
                    }

                    ui.jqXHR.success(function() {
                        ui.tab.data( "loaded", true );
                    });
                },
                load: function(event, ui){
                    _show_all($(ui.panel[0].children[0]).attr('id'));
                }
            });
            _show_all('{{ part }}');
        });
{% endblock %}
