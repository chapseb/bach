{#

This file is part Bach.

(c) Anaphore <info@anaphore.eu>

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.

#}

{% extends base_template %}

{% block css %}
    {{ parent() }}
    {% stylesheets
        'js/leaflet/leaflet.css'
        'js/leaflet/leaflet.fullscreen/Control.FullScreen.css'
        'js/leaflet/leaflet.geosearch/l.geosearch.css'
        output='assetic/css/compiled/leaflet_plugins.css'
        filter='cssrewrite'
    %}
    <link href="{{ asset_url }}" type="text/css" rel="stylesheet" media="screen" />
    {% endstylesheets %}
    <link href="{{ asset('js/leaflet/leaflet.sidebar/L.Control.Sidebar.css') }}" type="text/css" rel="stylesheet" media="screen" />
{% endblock %}

{% block js_calls %}
    {{ parent() }}
    <script src="{{ asset('js/leaflet/leaflet.js') }}" type="text/javascript"></script>
    {% javascripts
        'js/leaflet/leaflet.fullscreen/Control.FullScreen.js'
        'js/leaflet/leaflet.geosearch/l.control.geosearch.js'
        'js/leaflet/leaflet.geosearch/l.geosearch.provider.openstreetmap.js'
        output='assetic/js/compiled/leaflet_plugins.js'
    %}
        <script src="{{ asset_url }}" type="text/javascript"></script>
    {% endjavascripts %}
    <script src="{{ asset('js/leaflet/leaflet.sidebar/L.Control.Sidebar.js') }}" type="text/javascript"></script>
    <script src="{{ asset('js/leaflet/leaflet.sidebarcontrol/L.Control.SidebarBtn.js') }}" type="text/javascript"></script>
{% endblock %}

{% block sonata_admin_content %}
    <div id="map" class="big"></div>
    <div id="sidebar">
        <div id="missing-list">
            <h3>{% trans %}Not geolocalized places{% endtrans %} ({{ missing|length }})</h3>
            <p>{% trans %}Click on a location to perform automatic search.{% endtrans %}</p>
            <ul>
            {% for origin, toponym in missing %}
                <li>
                    <a class="geoloc" href="#">{{ origin }}</a>
                </li>
            {% endfor %}
            </ul>
        </div>
        <div id="proposal"class="hidden">
            <h3>{% trans %}Proposals for: {% endtrans %}<br/><em class="placename"></em></h3>
            <a class="back">{% trans %}Back{% endtrans %}</a>
            <div class="list"></div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    var allpoints;
    var current;
    var selected;

    /**
     * Returns element height, including margins
     */
    function _eltRealSize(_elt) {
        var _s = 0;
        _s += _elt.outerHeight();
        _s += parseFloat(_elt.css('margin-top').replace('px', ''));
        _s += parseFloat(_elt.css('margin-bottom').replace('px', ''));
        return _s;
    }

    var _features_stored = [];
    function onEachFeature(feature, layer) {
        var _content = '{{ 'Possible position for location:'|trans|escape('js') }}';
        _content += '<ul>';
        _content += '<li>{{ 'Original:'|trans|escape('js') }} <em>' + current + '</em></em></li>';
        _content += '<li>{{ 'Found:'|trans|escape('js') }} ' + feature.properties.name  + ' ({{ 'OSM id:'|trans|escape('js') }} ' + feature.properties.osm_id + ')</li>';
        _content += '<li>{{ 'Coordinates:'|trans|escape('js') }} ' + feature.properties.lat + '/' + feature.properties.lon  + '</li>';
        _content += '</ul>';
        var _count = _features_stored.length;
        _features_stored[_count] = feature.properties.elt;
        _content += '<a href="#' + _count  + '" class="store">{{ 'Store that position?'|trans|escape('js') }}</a>';
        popup = layer.bindPopup(_content);
    }

    var _layers;

    $(function(){
        $('.geoloc').on('click', function(){
            var _this = $(this);
            _this.closest('div').addClass('hidden');

            current = _this.html();
            var _proposal = $('#proposal');

            _proposal.removeClass('hidden')
                .find('.placename').html(current);
            var _list = _proposal.find('.list');

            var _da_url = '{{ path('bach_toponym_geoloc', {name: 'NAME'}) }}';

            _list.empty();
            $.ajax({
                url: _da_url.replace('NAME', _this.html()),
                {% include '::loader.js.twig' with {'parent_elt': '#sidebar', 'error_message': 'Unable to propose positions :('|trans} %}
                success: function(data) {
                    if ( data.length > 0 ) {
                        var _ul = $('<ul></ul>');

                        if ( _layers ) {
                            _layers.clearLayers();
                        }
                        var _features = [];
                        _features_stored = [];

                        data.forEach(function(elt) {
                            var _a = $('<a href="#" id="id_' + elt.osm_id  + '">' + elt.name + ' (' + elt.osm_id + ')'  + '</a>');

                            _feature = JSON.parse(elt.geojson);
                            _feature['properties'] = {
                                'indexed_name': elt.indexed_name,
                                'name': elt.name,
                                'osm_id': elt.osm_id,
                                'lat': elt.lat,
                                'lon': elt.lon,
                                'bbox': elt.bbox,
                                'elt': elt
                            }
                            _features[_features.length] = _feature;
                            _a.on('click', function(){
                                var _bbox = elt.bbox.split(',');
                                var _bounds = L.latLngBounds(
                                    L.latLng(_bbox[0], _bbox[2]),
                                    L.latLng(_bbox[1], _bbox[3])
                                );
                                map.fitBounds(_bounds, {
                                    padding: [50, 50],
                                    maxZoom: 13
                                });

                                return false;
                            });

                            var _li = $('<li></li>');
                            _a.appendTo(_li);
                            _li.appendTo(_ul);
                        });

                        var _geojson = {
                            "type": "FeatureCollection",
                            "features": _features
                        };

                        allpoints = L.geoJson(_geojson, {
                            onEachFeature: onEachFeature
                        });

                        _layers = L.layerGroup([allpoints]).addTo(map);
                        popup.openPopup();
                        map.fitBounds(allpoints.getBounds(), {
                            padding: [50, 50],
                            maxZoom: 13
                        });

                        map.on('popupopen', function(e){
                            var _link = $(e.popup._contentNode).find('.store');
                            _link.off();
                            _link.on('click', function() {
                                var _this = $(this);
                                var _count = _this.attr('href').replace('#', '');

                                $.ajax({
                                    url: '{{ path('bach_store_geoloc') }}',
                                    method: 'POST',
                                    data: _features_stored[_count],
                                    {% include '::loader.js.twig' with {'parent_elt': '#map', 'error_message': 'Unable to store that location :('|trans} %}
                                    success: function(data) {
                                        if ( data.success === true ) {
                                            alert('{{ 'Position has been successfully stored!'|trans|escape('js') }}');

                                            $('#proposal').addClass('hidden');
                                            $('#missing-list').removeClass('hidden');
                                            _layers.clearLayers();

                                            $('#missing-list li').filter(
                                                function(){
                                                    return $(this).find('a').text() === data.name
                                                }
                                            ).remove();
                                        } else {
                                            alert('{{ 'Something went wrong trying to store position :('|trans|escape('js') }}');
                                        }
                                    }
                                });
                                return false;
                            });
                        });
                        _list.append(_ul);
                    } else {
                        _list.append('<p>{{ 'No results found :/'|trans|escape('js') }}</p>');
                    }

                    var _free_search = $('<p>{{ 'No satisfying matches? Enter you own search:'|trans|escape('js') }}</p><input type="text" id="free_search" value="'+ _this.html() +'"/>');
                    _list.append(_free_search);
                }
            });

            return false;
        });

        $('.back').on('click', function(){
            var _this = $(this);
            _this.parent('div').addClass('hidden');
            $('#missing-list').removeClass('hidden');
            current = null;
            selected = null;
            if ( _layers ) {
                _layers.clearLayers();
            }
        });

        var wheight = $(window).height();
        var _oSize = 0;

        _oSize += _eltRealSize($('#navigation'));
        _oSize += _eltRealSize($('.navbar'));
        _oSize += parseFloat(
            $('#container').css('padding-top').replace('px', '')
        );
        _oSize += parseFloat(
            $('#container').css('padding-bottom').replace('px', '')
        );

        var newHeight = Math.floor(wheight - _oSize) + "px";
        $("#map").css("height", newHeight);

        var map;

        map = L.map('map', {
            minZoom: 1
        }).setView([47.010, 5.087], 5);

        var fullScreen = new L.Control.FullScreen();
        map.addControl(fullScreen);

        var sidebar = L.control.sidebar('sidebar', {
            position: 'right'
        });

        sidebar.on('hide show', function () {
            $('.leaflet-control-sidebarbtn').toggleClass('show');
        });

        map.addControl(sidebar);
        sidebar.show();

        L.control.sidebarbtn({
            strings: {
                title: '{{ 'Show/Hide sidebar'|trans|escape('js') }}'
            },
            sidebar: sidebar
        }).addTo(map);

        L.tileLayer('{{ tiles_url }}', {
            maxZoom: 18,
            attribution: '{{ '© Cartographic data'|trans|escape('js') }} <a href="http://openstreetmap.org">{{ 'OpenStreetMap contributors'|trans|escape('js') }}</a>, {{ '© Imagery'|trans|escape('js') }} {{ tiles_attribution|raw }}'
        }).addTo(map);

    });
{% endblock %}
